<ion-header id='table-header' *ngIf='table'>
  <ion-toolbar>
    <ion-buttons slot="start" *ngIf='selectedBillIndex != -1 && !showingHistory'>
      <div class='bill-name'>
        <ion-menu-button style='position: absolute;left:0;top:-7px;'></ion-menu-button>
        {{table.bills[selectedBillIndex]?.name}}
        <ion-button fill='clear' color="primary" (click)='selectBill()'>
          <ion-icon name="documents-outline"></ion-icon>
        </ion-button>
      </div>
    </ion-buttons>
    <ion-title>
      {{table.name}}
      <ion-button class='change-table-button' fill='clear' [hidden]='!table.canChangePlace || !table.opened' color="primary" (click)='changeTable()'>
        <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)='toggleHistory()' [hidden]='selectedBillIndex == -1 || !table.history.length' color="warning" class='history-button'><ion-icon name="timer"></ion-icon></ion-button>
      <ion-button color="primary" fill='solid' (click)='backButton()' class='show-tables'>Mesas</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content *ngIf='selectedBillIndex == -1 || showingHistory'>
  <div class='condensed-bills'>
    <ion-card [class.history]='showingHistory' [class.sent]='bill.sent' class='bill click-effect' *ngFor='let bill of condensedBills;let i = index;' (click)='selectBill(i)'>
      <ion-card-header>
        <ion-card-title>
          {{bill.name}}
          <ion-button [hidden]='showingHistory' style='position: absolute;top: -11px;' fill='clear' color="primary" (click)='renameBill(i);$event.stopPropagation()'>
            <ion-icon name="create-outline"></ion-icon>
          </ion-button>
        </ion-card-title>
        <ion-button [hidden]='showingHistory' [color]='bill.sent ? "success" : "primary"' style='margin-top:10px;' expand='full' color='success' (click)='closeBill(i);$event.stopPropagation();'>Cerrar</ion-button>
      </ion-card-header>
      <ion-list *ngIf='bill.newBatch && bill.newBatch.articles.length' class='articles new-batch' lines='full'>
        <div>
          <ion-item *ngFor='let article of bill.newBatch.articles' class='article'>
            <div class='quantity'>{{ article.q }}</div>
            <div class='name'>
              {{menu.articles[article.ami].name}}
              <div *ngFor='let ingredientIndex of article.pii;'>
                + {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngFor='let ingredientIndex of article.mii;'>
                - {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngIf='article.half && article.half.ami != null'>
                Mitad {{menu.articles[article.half.ami].name}}
                <div *ngFor='let ingredientIndex of article.half.pii;'>
                  + {{menu.ingredients[ingredientIndex].name}}
                </div>
                <div *ngFor='let ingredientIndex of article.half.mii;'>
                  - {{menu.ingredients[ingredientIndex].name}}
                </div>
              </div>
            </div>
          </ion-item>
        </div>
      </ion-list>
      <ion-list class='articles' lines='full'>
        <div>
          <ion-item *ngFor='let article of bill.articles' class='article'>
            <div class='quantity'>{{ article.q }}</div>
            <div class='name'>
              {{menu.articles[article.ami].name}}
              <div *ngFor='let ingredientIndex of article.pii;'>
                + {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngFor='let ingredientIndex of article.mii;'>
                - {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngIf='article.half && article.half.ami != null'>
                Mitad {{menu.articles[article.half.ami].name}}
                <div *ngFor='let ingredientIndex of article.half.pii;'>
                  + {{menu.ingredients[ingredientIndex].name}}
                </div>
                <div *ngFor='let ingredientIndex of article.half.mii;'>
                  - {{menu.ingredients[ingredientIndex].name}}
                </div>
              </div>
            </div>
          </ion-item>
        </div>
      </ion-list>
    </ion-card>
  </div>
</ion-content>

<ion-content *ngIf='table && table.bills[selectedBillIndex] && !showingHistory'>
  <div id='table'>
    <div class='bill'>
      <ion-list class='articles' lines='full'>
        <div *ngIf='table.bills[this.selectedBillIndex].newBatch.articles.length'>
          <ion-item-divider color='medium'>
            <ion-label>
              {{table.bills[this.selectedBillIndex].newBatch.waiterName}} - {{table.bills[this.selectedBillIndex].newBatch.date}}
            </ion-label>
          </ion-item-divider>
          <ion-button (click)='sendToKitchen()' expand='full' color='success'>Enviar</ion-button>
          <ion-item *ngFor='let article of table.bills[this.selectedBillIndex].newBatch.articles; let i = index' class='article click-effect' (click)='modifyArticle(table.bills[this.selectedBillIndex].newBatch, i)'>
            <div class='name'>
              {{menu.articles[article.ami].name}}
              <div *ngFor='let ingredientIndex of article.pii;'>
                + {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngFor='let ingredientIndex of article.mii;'>
                - {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngIf='article.half && article.half.ami != null'>
                Mitad {{menu.articles[article.half.ami].name}}
                <div *ngFor='let ingredientIndex of article.half.pii;'>
                  + {{menu.ingredients[ingredientIndex].name}}
                </div>
                <div *ngFor='let ingredientIndex of article.half.mii;'>
                  - {{menu.ingredients[ingredientIndex].name}}
                </div>
              </div>
            </div>
            <div class='price'>{{billService.getArticlePrice(article)}}</div>
          </ion-item>
        </div>
        <div *ngFor='let batch of table.bills[selectedBillIndex].batches;'>
          <ion-item-divider color='tertiary'>
            <ion-label>
              {{batch.waiterName}} - {{batch.date}}
            </ion-label>
          </ion-item-divider>
          <ion-item *ngFor='let article of batch.articles; let i = index' class='article click-effect' (click)='modifyArticle(batch, i)'>
            <div class='name'>
              {{menu.articles[article.ami].name}}
              <div *ngFor='let ingredientIndex of article.pii;'>
                + {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngFor='let ingredientIndex of article.mii;'>
                - {{menu.ingredients[ingredientIndex].name}}
              </div>
              <div *ngIf='article.half && article.half.ami != null'>
                Mitad {{menu.articles[article.half.ami].name}}
                <div *ngFor='let ingredientIndex of article.half.pii;'>
                  + {{menu.ingredients[ingredientIndex].name}}
                </div>
                <div *ngFor='let ingredientIndex of article.half.mii;'>
                  - {{menu.ingredients[ingredientIndex].name}}
                </div>
              </div>
            </div>
            <div class='price'>{{billService.getArticlePrice(article)}}</div>
          </ion-item>
        </div>
      </ion-list>
      <ion-list class='taxes' lines='full'>
        <ion-item class='service'>
          <ion-checkbox slot="start" [(ngModel)]='table.bills[this.selectedBillIndex].service'></ion-checkbox>
          <ion-label>Servicio <span>{{billService.getService(table.bills[this.selectedBillIndex]) | number}}</span></ion-label>
        </ion-item>
        <ion-item>
          <ion-checkbox slot="start" [(ngModel)]='table.bills[this.selectedBillIndex].itbis'></ion-checkbox>
          <ion-label>ITBIS <span>{{billService.getItbis(table.bills[this.selectedBillIndex]) | number}}</span></ion-label>
        </ion-item>
      </ion-list>
      <ion-list lines='full'>
        <ion-item (click)='printBill()'color='primary' class='total'>
          <ion-button (click)='deleteBill();$event.stopPropagation();' style='margin-right:10px;'><ion-icon name="trash"></ion-icon></ion-button>
          <ion-label>TOTAL <span class='nb'>{{billService.getTotal(table.bills[this.selectedBillIndex]) | number}}</span></ion-label>
        </ion-item>
      </ion-list>
    </div>
    <div class='choosing-articles' *ngIf='menu'>
      <div class='categories'>
        <ng-container *ngFor='let category of menu.articleCategories;let i = index'>
          <ion-button *ngIf='category.display' color='light' mode="ios" (click)='shortcut(i)'>{{category.name}}</ion-button>
        </ng-container>
      </div>
      <div id='articles-list'>
        <ng-container *ngFor='let category of menu.articleCategories;let i = index'>
          <ion-item-group *ngIf='category.display' id='shortcut-{{i}}'>
            <ion-item-divider color='medium' class='ion-text-center'>
              <ion-label class='width-100'>{{category.name}}</ion-label>
            </ion-item-divider>
            <div class='category' *ngIf="category.articleIndexes.length / 2 as stop">
              <ion-list lines='full'>
                <ng-container *ngFor='let articleIndex of category.articleIndexes; let i = index;'>
                  <ion-item class='click-effect' (click)='addArticleIndex(articleIndex)' *ngIf='i < stop'>
                    <label>{{menu.articles[articleIndex].name}}</label>
                    <label slot='end'>{{menu.articles[articleIndex].price}}</label>
                  </ion-item>
                </ng-container>
              </ion-list>
              <ion-list lines='full'>
                <ng-container *ngFor='let articleIndex of category.articleIndexes; let i = index;'>
                  <ion-item class='click-effect' (click)='addArticleIndex(articleIndex)' *ngIf='i >= stop'>
                    <label>{{menu.articles[articleIndex].name}}</label>
                    <label slot='end'>{{menu.articles[articleIndex].price}}</label>
                  </ion-item>
                </ng-container>
              </ion-list>
            </div>
          </ion-item-group>
        </ng-container>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer [hidden]='selectedBillIndex != -1' color='success' style='text-align:center'>
  <ion-button (click)='addBill()' expand='full'>
    <ion-icon slot='icon-only' size='large' name="add-circle-outline"></ion-icon>
  </ion-button>
</ion-footer>
